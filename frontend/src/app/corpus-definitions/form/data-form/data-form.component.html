@let fileState = fileState$ | async;
@let dataFiles = dataFiles$ | async;
@let confirmed = confirmed$ | async;
@let unconfirmed = unconfirmed$ | async;

<h1 class="title">Upload a sample of your data</h1>
<p class="subtitle">
    Determines sensible default values for the fields of your corpus
</p>

<button class="button" (click)="openDocumentation()">Manual</button>

@switch (fileState) {
    @case ("noneUploaded") {
        <p>You have not uploaded a data file yet.</p>
    }

    @case ("firstUploaded") {
        <ia-datafile-info [currentDataFile]="unconfirmed$ | async" />
        <p>
            If this is what you expected, click "use this file" to base your
            corpus on this data file.
        </p>
        <p>In the next step, you can configure the fields in more detail.</p>
        <p>
            If this does not seem correct, please consult the manual and make
            sure the file is formatted correctly.
        </p>
        <p>
            You can use "reset" to remove your data file, or "replace" to upload
            a different one.
        </p>
    }

    @case ("firstConfirmed") {
        <ia-datafile-info [currentDataFile]="confirmed" />
    }

    @case ("newUploaded") {
         <ia-datafile-info
                [currentDataFile]="confirmed"
                [newDataFile]="unconfirmed"
                (onCurrentSelected)="onReplaceReject()"
                (onNewSelected)="onReplaceAccept()"
            ></ia-datafile-info>
    }
}

@if (fileState === "firstUploaded" || fileState === "firstConfirmed") {
    <div class="field is-grouped">
        <button class="button" (click)="confirmReset.open(dataFiles)">
            <span class="icon" aria-hidden="true">
                <fa-icon [icon]="formIcons.reset"></fa-icon>
            </span>
            <span>Reset</span>
        </button>
        <div class="file mb-0">
            <label class="file-label">
                <input
                    class="file-input"
                    type="file"
                    name="definition-upload"
                    accept=".csv,.tsv,text/csv,text/tab-separated-values "
                    (input)="onUpload($event)"
                />
                <span class="file-cta">
                    <span class="file-icon" aria-hidden="true">
                        <fa-icon [icon]="formIcons.replace"></fa-icon>
                    </span>
                    <span class="file-label">Replace file</span>
                </span>
            </label>
        </div>
        @if (fileState === "firstUploaded") {
            <button class="button is-primary" (click)="confirmFile()">
                <span class="icon" aria-hidden="true">
                    <fa-icon [icon]="formIcons.confirm"></fa-icon>
                </span>
                <span>Use this file</span>
            </button>
        }
    </div>
}

@if (fileState === "noneUploaded") {
    <form>
        <div class="field">
            <div class="file">
                <label class="file-label">
                    <input
                        class="file-input"
                        type="file"
                        name="definition-upload"
                        accept=".csv,.tsv,text/csv,text/tab-separated-values "
                        (input)="onUpload($event)"
                    />
                    <span class="file-cta">
                        <span class="file-icon" aria-hidden="true">
                            <fa-icon [icon]="actionIcons.upload"></fa-icon>
                        </span>
                        <span class="file-label">Upload CSV file...</span>
                    </span>
                </label>
            </div>
        </div>

        <div class="message is-danger" *ngIf="error$ | async as error">
            <div class="message-header">Invalid file</div>
            <div class="message-body">
                An error occurred when reading the file: {{ error.message }}
            </div>
        </div>
    </form>
}

<!-- Reset confirmation -->
<ia-confirm-modal
    #confirmReset
    actionText="Remove data file"
    [handleAsync]="handleReset"
    (accept)="onResetComplete()"
>
    @if (confirmed) {
        <p>
            This will delete the file
            <code>{{ confirmed.original_filename }}</code> and will reset the
            form to this step. You will need to upload a new file before you can
            continue.
        </p>
    }
    @if (unconfirmed) {
        <p>
            This will delete the file
            <code>{{ unconfirmed.original_filename }}</code
            >.
        </p>
    }
</ia-confirm-modal>
